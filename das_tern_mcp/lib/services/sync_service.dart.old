import 'dart:async';
import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:connectivity_plus/connectivity_plus.dart';
import 'database_service.dart';
import 'api_service.dart';
import '../models/medication_model/medication.dart';
import '../models/dose_event_model/dose_event.dart';

class SyncService {
  static final SyncService instance = SyncService._init();
  SyncService._init();

  final DatabaseService _db = DatabaseService.instance;
  final ApiService _api = ApiService.instance;
  final Connectivity _connectivity = Connectivity();
  
  StreamSubscription<ConnectivityResult>? _connectivitySubscription;
  bool _isSyncing = false;

  void startListening() {
    _connectivitySubscription = _connectivity.onConnectivityChanged.listen((result) {
      if (result == ConnectivityResult.mobile || 
          result == ConnectivityResult.wifi) {
        syncPendingChanges();
      }
    });
  }

  void stopListening() {
    _connectivitySubscription?.cancel();
  }

  Future<bool> isOnline() async {
    final result = await _connectivity.checkConnectivity();
    return result == ConnectivityResult.mobile || 
           result == ConnectivityResult.wifi;
  }

  Future<void> syncPendingChanges() async {
    if (_isSyncing) return;
    
    final online = await isOnline();
    if (!online) return;

    _isSyncing = true;
    try {
      await _processSyncQueue();
      await syncMedications();
    } catch (e) {
      debugPrint('Sync error: $e');
    } finally {
      _isSyncing = false;
    }
  }

  Future<void> _processSyncQueue() async {
    final queue = await _db.getSyncQueue();
    
    for (final item in queue) {
      try {
        final action = item['action'] as String;
        final tableName = item['table_name'] as String;
        final data = jsonDecode(item['data'] as String);

        if (tableName == 'medications') {
          final medication = Medication.fromJson(data);
          if (action == 'create') {
            await _api.createMedication(medication);
          } else if (action == 'update') {
            await _api.updateMedication(medication);
          }
        } else if (tableName == 'dose_events') {
          final doseEvent = DoseEvent.fromJson(data);
          if (action == 'update') {
            await _api.updateDoseEvent(doseEvent);
          }
        }

        await _db.removeSyncedItem(item['id'] as int);
      } catch (e) {
        debugPrint('Failed to sync item ${item['id']}: $e');
        // Keep in queue for retry
      }
    }
  }

  Future<void> syncMedications() async {
    try {
      final remoteMedications = await _api.getMedications();
      
      for (final medication in remoteMedications) {
        final local = await _db.getMedicationById(medication.id!);
        if (local == null) {
          await _db.createMedication(medication.copyWith(synced: true));
        } else if (medication.updatedAt.isAfter(local.updatedAt)) {
          await _db.updateMedication(medication.copyWith(synced: true));
        }
      }
    } catch (e) {
      debugPrint('Failed to sync medications from server: $e');
    }
  }
}
