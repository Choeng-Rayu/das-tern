import 'dart:convert';
import 'package:flutter/material.dart';
import '../models/dose_event_model/dose_event.dart';
import '../models/enums_model/dose_status.dart';
import '../services/database_service.dart';
import '../services/sync_service.dart';
import '../services/notification_service.dart';

class DoseEventProvider extends ChangeNotifier {
  final DatabaseService _db = DatabaseService.instance;
  final SyncService _sync = SyncService.instance;
  final NotificationService _notifications = NotificationService.instance;

  List<DoseEvent> _todayDoseEvents = [];
  bool _isLoading = false;
  String? _errorMessage;

  List<DoseEvent> get todayDoseEvents => _todayDoseEvents;
  bool get isLoading => _isLoading;
  String? get errorMessage => _errorMessage;

  int get completedCount => 
      _todayDoseEvents.where((e) => e.status == DoseStatus.taken).length;
  
  int get totalCount => _todayDoseEvents.length;

  Future<void> loadTodayDoseEvents() async {
    _isLoading = true;
    _errorMessage = null;
    notifyListeners();

    try {
      _todayDoseEvents = await _db.getDoseEventsByDate(DateTime.now());
      _isLoading = false;
      notifyListeners();
    } catch (e) {
      _errorMessage = 'Failed to load dose events: $e';
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> markAsTaken(DoseEvent doseEvent) async {
    try {
      final now = DateTime.now();
      final scheduledTime = doseEvent.scheduledTime;
      final difference = now.difference(scheduledTime).inMinutes;

      // Determine status based on time window
      final status = difference.abs() <= 30 
          ? DoseStatus.taken 
          : DoseStatus.takenLate;

      final updated = doseEvent.copyWith(
        status: status,
        takenTime: now,
      );

      await _db.updateDoseEvent(updated);

      // Cancel notification
      if (doseEvent.id != null) {
        await _notifications.cancelReminder(doseEvent.id!);
      }

      // Add to sync queue
      await _db.addToSyncQueue(
        'update',
        'dose_events',
        doseEvent.id!,
        jsonEncode(updated.toJson()),
      );

      await _sync.syncPendingChanges();
      await loadTodayDoseEvents();
    } catch (e) {
      _errorMessage = 'Failed to mark as taken: $e';
      notifyListeners();
      rethrow;
    }
  }

  List<DoseEvent> getDoseEventsByTimeGroup(String timeGroup) {
    if (timeGroup == 'daytime') {
      // 6:00 AM - 5:59 PM
      return _todayDoseEvents.where((event) {
        final hour = event.scheduledTime.hour;
        return hour >= 6 && hour < 18;
      }).toList();
    } else {
      // 6:00 PM - 5:59 AM
      return _todayDoseEvents.where((event) {
        final hour = event.scheduledTime.hour;
        return hour >= 18 || hour < 6;
      }).toList();
    }
  }
}
