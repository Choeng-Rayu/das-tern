// Prisma Schema for Das Tern Backend
// Prisma Version: 6.2.0
// PostgreSQL Version: 17
// Database: dastern

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  PATIENT
  DOCTOR
  FAMILY_MEMBER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Language {
  KHMER
  ENGLISH
}

enum Theme {
  LIGHT
  DARK
}

enum AccountStatus {
  ACTIVE
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
  LOCKED
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REVOKED
}

enum PermissionLevel {
  NOT_ALLOWED
  REQUEST
  SELECTED
  ALLOWED
}

enum PrescriptionStatus {
  DRAFT
  ACTIVE
  PAUSED
  INACTIVE
}

enum TimePeriod {
  DAYTIME
  NIGHT
}

enum DoseEventStatus {
  DUE
  TAKEN_ON_TIME
  TAKEN_LATE
  MISSED
  SKIPPED
}

enum SubscriptionTier {
  FREEMIUM
  PREMIUM
  FAMILY_PREMIUM
}

enum NotificationType {
  CONNECTION_REQUEST
  PRESCRIPTION_UPDATE
  MISSED_DOSE_ALERT
  URGENT_PRESCRIPTION_CHANGE
  FAMILY_ALERT
}

enum AuditActionType {
  CONNECTION_REQUEST
  CONNECTION_ACCEPT
  CONNECTION_REVOKE
  PERMISSION_CHANGE
  PRESCRIPTION_CREATE
  PRESCRIPTION_UPDATE
  PRESCRIPTION_CONFIRM
  PRESCRIPTION_RETAKE
  DOSE_TAKEN
  DOSE_SKIPPED
  DOSE_MISSED
  DATA_ACCESS
  NOTIFICATION_SENT
  SUBSCRIPTION_CHANGE
}

// ============================================
// USER MODEL
// ============================================

model User {
  id                   String         @id @default(uuid()) @db.Uuid
  role                 UserRole
  
  // Basic Information
  firstName            String?        @db.VarChar(100)
  lastName             String?        @db.VarChar(100)
  fullName             String?        @db.VarChar(200)
  phoneNumber          String         @unique @db.VarChar(20)
  email                String?        @unique @db.VarChar(255)
  passwordHash         String         @db.VarChar(255)
  pinCodeHash          String?        @db.VarChar(255)
  
  // Personal Details
  gender               Gender?
  dateOfBirth          DateTime?      @db.Date
  idCardNumber         String?        @unique @db.VarChar(50)
  
  // Preferences
  language             Language       @default(KHMER)
  theme                Theme          @default(LIGHT)
  
  // Doctor-specific fields
  hospitalClinic       String?        @db.VarChar(255)
  specialty            String?        @db.VarChar(100)
  licenseNumber        String?        @unique @db.VarChar(100)
  licensePhotoUrl      String?        @db.Text
  
  // Account Security
  accountStatus        AccountStatus  @default(ACTIVE)
  failedLoginAttempts  Int            @default(0)
  lockedUntil          DateTime?      @db.Timestamptz(3)
  
  // Timestamps
  createdAt            DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt            DateTime       @updatedAt @db.Timestamptz(3)
  
  // Relations
  initiatedConnections Connection[]   @relation("ConnectionInitiator")
  receivedConnections  Connection[]   @relation("ConnectionRecipient")
  prescriptionsAsPatient Prescription[] @relation("PatientPrescriptions")
  prescriptionsAsDoctor  Prescription[] @relation("DoctorPrescriptions")
  doseEvents           DoseEvent[]
  notifications        Notification[]
  auditLogs            AuditLog[]
  subscription         Subscription?
  familyMemberships    FamilyMember[]
  mealTimePreference   MealTimePreference?
  prescriptionVersions PrescriptionVersion[]
  
  @@index([phoneNumber])
  @@index([email])
  @@index([role])
  @@index([accountStatus])
  @@map("users")
}

// ============================================
// CONNECTION MODEL
// ============================================

model Connection {
  id              String           @id @default(uuid()) @db.Uuid
  initiatorId     String           @db.Uuid
  recipientId     String           @db.Uuid
  status          ConnectionStatus @default(PENDING)
  permissionLevel PermissionLevel  @default(ALLOWED)
  
  // Timestamps
  requestedAt     DateTime         @default(now()) @db.Timestamptz(3)
  acceptedAt      DateTime?        @db.Timestamptz(3)
  revokedAt       DateTime?        @db.Timestamptz(3)
  createdAt       DateTime         @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime         @updatedAt @db.Timestamptz(3)
  
  // Relations
  initiator       User             @relation("ConnectionInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  recipient       User             @relation("ConnectionRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  
  @@unique([initiatorId, recipientId])
  @@index([initiatorId])
  @@index([recipientId])
  @@index([status])
  @@map("connections")
}

// ============================================
// PRESCRIPTION MODELS
// ============================================

model Prescription {
  id             String             @id @default(uuid()) @db.Uuid
  patientId      String             @db.Uuid
  doctorId       String?            @db.Uuid
  
  // Patient Info (snapshot at creation)
  patientName    String             @db.VarChar(200)
  patientGender  Gender
  patientAge     Int
  symptoms       String             @db.Text
  
  // Prescription Details
  status         PrescriptionStatus @default(DRAFT)
  currentVersion Int                @default(1)
  isUrgent       Boolean            @default(false)
  urgentReason   String?            @db.Text
  
  // Timestamps
  createdAt      DateTime           @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime           @updatedAt @db.Timestamptz(3)
  
  // Relations
  patient        User               @relation("PatientPrescriptions", fields: [patientId], references: [id], onDelete: Cascade)
  doctor         User?              @relation("DoctorPrescriptions", fields: [doctorId], references: [id], onDelete: SetNull)
  medications    Medication[]
  doseEvents     DoseEvent[]
  versions       PrescriptionVersion[]
  
  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([patientId, status])
  @@map("prescriptions")
}

model PrescriptionVersion {
  id                  String   @id @default(uuid()) @db.Uuid
  prescriptionId      String   @db.Uuid
  versionNumber       Int
  authorId            String?  @db.Uuid
  changeReason        String?  @db.Text
  medicationsSnapshot Json     @db.JsonB
  
  // Timestamps
  createdAt           DateTime @default(now()) @db.Timestamptz(3)
  
  // Relations
  prescription        Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  author              User?        @relation(fields: [authorId], references: [id], onDelete: SetNull)
  
  @@unique([prescriptionId, versionNumber])
  @@index([prescriptionId])
  @@map("prescription_versions")
}

model Medication {
  id               String       @id @default(uuid()) @db.Uuid
  prescriptionId   String       @db.Uuid
  rowNumber        Int
  
  // Medication Details
  medicineName     String       @db.VarChar(255)
  medicineNameKhmer String?     @db.VarChar(255)
  imageUrl         String?      @db.Text
  
  // Dosage Information (JSONB for flexibility)
  morningDosage    Json?        @db.JsonB
  daytimeDosage    Json?        @db.JsonB
  nightDosage      Json?        @db.JsonB
  
  // Additional Info
  frequency        String?      @db.VarChar(100)
  timing           String?      @db.VarChar(100)
  
  // Timestamps
  createdAt        DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime     @updatedAt @db.Timestamptz(3)
  
  // Relations
  prescription     Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  doseEvents       DoseEvent[]
  
  @@index([prescriptionId])
  @@map("medications")
}

// ============================================
// DOSE EVENT MODEL
// ============================================

model DoseEvent {
  id             String          @id @default(uuid()) @db.Uuid
  prescriptionId String          @db.Uuid
  medicationId   String          @db.Uuid
  patientId      String          @db.Uuid
  
  // Schedule Information
  scheduledTime  DateTime        @db.Timestamptz(3)
  timePeriod     TimePeriod
  reminderTime   String?         @db.VarChar(10)
  
  // Status Tracking
  status         DoseEventStatus @default(DUE)
  takenAt        DateTime?       @db.Timestamptz(3)
  skipReason     String?         @db.Text
  wasOffline     Boolean         @default(false)
  
  // Timestamps
  createdAt      DateTime        @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime        @updatedAt @db.Timestamptz(3)
  
  // Relations
  prescription   Prescription    @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medication     Medication      @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  patient        User            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([scheduledTime])
  @@index([status])
  @@index([patientId, scheduledTime])
  @@index([prescriptionId])
  @@map("dose_events")
}

// ============================================
// NOTIFICATION MODEL
// ============================================

model Notification {
  id          String           @id @default(uuid()) @db.Uuid
  recipientId String           @db.Uuid
  type        NotificationType
  
  // Content
  title       String           @db.VarChar(255)
  message     String           @db.Text
  data        Json?            @db.JsonB
  
  // Status
  isRead      Boolean          @default(false)
  readAt      DateTime?        @db.Timestamptz(3)
  
  // Timestamps
  createdAt   DateTime         @default(now()) @db.Timestamptz(3)
  
  // Relations
  recipient   User             @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  
  @@index([recipientId])
  @@index([recipientId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// AUDIT LOG MODEL
// ============================================

model AuditLog {
  id           String          @id @default(uuid()) @db.Uuid
  actorId      String?         @db.Uuid
  actorRole    UserRole?
  actionType   AuditActionType
  resourceType String          @db.VarChar(100)
  resourceId   String?         @db.Uuid
  details      Json?           @db.JsonB
  ipAddress    String?         @db.VarChar(45)
  
  // Timestamps
  createdAt    DateTime        @default(now()) @db.Timestamptz(3)
  
  // Relations
  actor        User?           @relation(fields: [actorId], references: [id], onDelete: SetNull)
  
  @@index([actorId])
  @@index([resourceId])
  @@index([createdAt])
  @@index([actionType])
  @@map("audit_logs")
}

// ============================================
// SUBSCRIPTION MODELS
// ============================================

model Subscription {
  id           String           @id @default(uuid()) @db.Uuid
  userId       String           @unique @db.Uuid
  tier         SubscriptionTier @default(FREEMIUM)
  
  // Storage Management
  storageQuota BigInt           @default(5368709120)
  storageUsed  BigInt           @default(0)
  
  // Subscription Details
  expiresAt    DateTime?        @db.Timestamptz(3)
  
  // Timestamps
  createdAt    DateTime         @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime         @updatedAt @db.Timestamptz(3)
  
  // Relations
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyMembers FamilyMember[]
  
  @@index([userId])
  @@index([tier])
  @@map("subscriptions")
}

model FamilyMember {
  id             String       @id @default(uuid()) @db.Uuid
  subscriptionId String       @db.Uuid
  memberId       String       @db.Uuid
  
  // Timestamps
  addedAt        DateTime     @default(now()) @db.Timestamptz(3)
  
  // Relations
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  member         User         @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([subscriptionId, memberId])
  @@index([subscriptionId])
  @@map("family_members")
}

// ============================================
// MEAL TIME PREFERENCE MODEL
// ============================================

model MealTimePreference {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @unique @db.Uuid
  
  // Meal Time Ranges
  morningMeal   String?  @db.VarChar(20)
  afternoonMeal String?  @db.VarChar(20)
  nightMeal     String?  @db.VarChar(20)
  
  // Timestamps
  createdAt     DateTime @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @db.Timestamptz(3)
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("meal_time_preferences")
}
