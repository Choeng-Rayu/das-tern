import 'package:sqflite/sqflite.dart';
import 'package:path/path.dart';
import '../models/medication_model/medication.dart';
import '../models/dose_event_model/dose_event.dart';

class DatabaseService {
  static final DatabaseService instance = DatabaseService._init();
  static Database? _database;

  DatabaseService._init();

  Future<Database> get database async {
    if (_database != null) return _database!;
    _database = await _initDB('dastern.db');
    return _database!;
  }

  Future<Database> _initDB(String filePath) async {
    final dbPath = await getDatabasesPath();
    final path = join(dbPath, filePath);

    return await openDatabase(
      path,
      version: 1,
      onCreate: _createDB,
    );
  }

  Future _createDB(Database db, int version) async {
    await db.execute('''
      CREATE TABLE medications (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        dosage TEXT NOT NULL,
        form TEXT NOT NULL,
        instructions TEXT,
        type TEXT NOT NULL,
        status TEXT NOT NULL,
        frequency INTEGER NOT NULL,
        reminder_times TEXT NOT NULL,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL,
        synced INTEGER NOT NULL DEFAULT 0
      )
    ''');

    await db.execute('''
      CREATE TABLE dose_events (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        medication_id INTEGER NOT NULL,
        scheduled_time TEXT NOT NULL,
        taken_time TEXT,
        status TEXT NOT NULL,
        notes TEXT,
        synced INTEGER NOT NULL DEFAULT 0,
        FOREIGN KEY (medication_id) REFERENCES medications (id) ON DELETE CASCADE
      )
    ''');

    await db.execute('''
      CREATE TABLE sync_queue (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        action TEXT NOT NULL,
        table_name TEXT NOT NULL,
        record_id INTEGER NOT NULL,
        data TEXT NOT NULL,
        created_at TEXT NOT NULL
      )
    ''');
  }

  // Medication CRUD
  Future<int> createMedication(Medication medication) async {
    final db = await database;
    return await db.insert('medications', medication.toMap());
  }

  Future<List<Medication>> getMedications() async {
    final db = await database;
    final result = await db.query('medications', orderBy: 'created_at DESC');
    return result.map((map) => Medication.fromMap(map)).toList();
  }

  Future<Medication?> getMedicationById(int id) async {
    final db = await database;
    final result = await db.query(
      'medications',
      where: 'id = ?',
      whereArgs: [id],
    );
    if (result.isEmpty) return null;
    return Medication.fromMap(result.first);
  }

  Future<List<Medication>> getMedicationsByStatus(String status) async {
    final db = await database;
    final result = await db.query(
      'medications',
      where: 'status = ?',
      whereArgs: [status],
    );
    return result.map((map) => Medication.fromMap(map)).toList();
  }

  Future<int> updateMedication(Medication medication) async {
    final db = await database;
    return await db.update(
      'medications',
      medication.toMap(),
      where: 'id = ?',
      whereArgs: [medication.id],
    );
  }

  Future<int> deleteMedication(int id) async {
    final db = await database;
    return await db.delete(
      'medications',
      where: 'id = ?',
      whereArgs: [id],
    );
  }

  // DoseEvent CRUD
  Future<int> createDoseEvent(DoseEvent doseEvent) async {
    final db = await database;
    return await db.insert('dose_events', doseEvent.toMap());
  }

  Future<List<DoseEvent>> getDoseEvents() async {
    final db = await database;
    final result = await db.query('dose_events', orderBy: 'scheduled_time ASC');
    return result.map((map) => DoseEvent.fromMap(map)).toList();
  }

  Future<List<DoseEvent>> getDoseEventsByMedicationId(int medicationId) async {
    final db = await database;
    final result = await db.query(
      'dose_events',
      where: 'medication_id = ?',
      whereArgs: [medicationId],
      orderBy: 'scheduled_time ASC',
    );
    return result.map((map) => DoseEvent.fromMap(map)).toList();
  }

  Future<List<DoseEvent>> getDoseEventsByDate(DateTime date) async {
    final db = await database;
    final startOfDay = DateTime(date.year, date.month, date.day);
    final endOfDay = startOfDay.add(const Duration(days: 1));
    
    final result = await db.query(
      'dose_events',
      where: 'scheduled_time >= ? AND scheduled_time < ?',
      whereArgs: [startOfDay.toIso8601String(), endOfDay.toIso8601String()],
      orderBy: 'scheduled_time ASC',
    );
    return result.map((map) => DoseEvent.fromMap(map)).toList();
  }

  Future<List<DoseEvent>> getPendingDoseEvents() async {
    final db = await database;
    final result = await db.query(
      'dose_events',
      where: 'status = ?',
      whereArgs: ['due'],
      orderBy: 'scheduled_time ASC',
    );
    return result.map((map) => DoseEvent.fromMap(map)).toList();
  }

  Future<int> updateDoseEvent(DoseEvent doseEvent) async {
    final db = await database;
    return await db.update(
      'dose_events',
      doseEvent.toMap(),
      where: 'id = ?',
      whereArgs: [doseEvent.id],
    );
  }

  // Sync Queue
  Future<int> addToSyncQueue(String action, String tableName, int recordId, String data) async {
    final db = await database;
    return await db.insert('sync_queue', {
      'action': action,
      'table_name': tableName,
      'record_id': recordId,
      'data': data,
      'created_at': DateTime.now().toIso8601String(),
    });
  }

  Future<List<Map<String, dynamic>>> getSyncQueue() async {
    final db = await database;
    return await db.query('sync_queue', orderBy: 'created_at ASC');
  }

  Future<int> removeSyncedItem(int id) async {
    final db = await database;
    return await db.delete(
      'sync_queue',
      where: 'id = ?',
      whereArgs: [id],
    );
  }

  Future close() async {
    final db = await database;
    db.close();
  }
}
